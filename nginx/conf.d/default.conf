# 定义后端上游服务
upstream backend_server {
    # "library_app" 对应 docker-compose 里的 container_name
    server library_app:8080;
}

# HTTP 强制跳转 HTTPS
server {
    listen 80;
    server_name localhost;
    return 301 https://$host$request_uri;
}

# HTTPS 服务
server {
    listen 443 ssl;
    server_name localhost;

    # SSL 证书路径 (对应 docker-compose 挂载后的容器内路径)
    ssl_certificate     /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # SSL 优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # --- 1. 静态资源 (图片) ---
    # 访问 https://localhost/uploads/xxx.jpg 时
    # Nginx 直接去 /usr/share/nginx/html/uploads/ 找文件
    location /uploads/ {
        # 这里对应 docker-compose 中 Nginx 服务的容器内路径
        alias /usr/share/nginx/html/uploads/;
        expires 7d;
    }
    # --- 2. API 接口 ---
    # 所有其他请求转发给 Go 后端
    location / {
        proxy_pass http://backend_server;
        
        # 传递客户端真实信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}